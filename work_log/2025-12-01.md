# Work Log: 2025-12-01

## Summary

Continued the MaNGA → lensing → CNN pipeline work, focusing on:
1. Tightening Milestone 1 (compactness metrics, toy SIS lens, lensed vs unlensed CNN)
2. Starting subhalo-detection experiments (Step-2)
3. Centralizing lensing physics into shared utilities
4. Running controlled ablation studies (flux-only vs vel-only vs both)

**Key outcome:** Milestone 1 is effectively complete. Subhalo experiments reveal that morphology (flux) dominates detection; velocity-only fails to rise above chance in all tested regimes.

---

## 1. Morning Alignment and Milestone 1 Status

### What remained for Milestone 1:
- Add compactness / quality metrics on the MaNGA MAPS (beyond simple "usable" flag)
- Wire up `prep_source_maps.py` cleanly to those metrics and to the usable index file
- Implement a toy lensing script using one of the high-quality galaxies as a canonical source
- Implement a toy CNN to distinguish unlensed vs lensed (single SIS macro lens) using 2-channel (flux + velocity) tensors

### Confirmed status:
- Project scaffolding, MAPS loading, initial quality checks, and tensor generation were already in place
- We were at the "final stretch" of Milestone 1

---

## 2. Compactness / Quality Metrics and Lensability Scoring

### Metrics reviewed in `maps_quality_summary.csv`:

| Metric | Description | Interpretation |
|--------|-------------|----------------|
| `vel_grad` | Approximate velocity gradient across the field | **Core proxy** for subhalo detectability |
| `frac_valid_in_1.5Re` | Valid spaxel fraction inside 1.5×R_e | **Best discriminator** of scientifically usable disks |
| `vel_std` | Overall amplitude of the velocity field | Signal strength indicator |
| `mask_fraction` | Global masked fraction (expected ~0.5 due to corners) | Sanity guard |
| `flux_max`, `flux_mean` | Rough brightness | Avoid extremely faint lines |
| `flux_vel_corr` | Near zero for nice rotating disks | Not a primary cut |
| Flags | `flag_low_rotation`, `flag_heavily_masked`, `flag_low_flux` | Mark problems |

### Implemented `lensibility_score` function:

**Hard reject criteria:**
- `frac_valid_in_1.5Re < 0.60`
- `vel_grad < 2.5`
- `mask_fraction > 0.70`
- `flux_max < 50`

**Scoring (when not rejected):**
- Add points for high `vel_grad`, high `frac_valid_in_1.5Re`, healthy `vel_std`, acceptable `mask_fraction`, reasonable `flux_max`, small `|flux_vel_corr|`

### Results on 10 MAPS:

| Plateifu | Tier | Notes |
|----------|------|-------|
| 8593-12705 | **Elite** | Score ~94 |
| 8993-12705 | **Elite** | Strong rotation |
| 11982-9102 | **Elite** | Excellent coverage |
| 10500-12703 | **Elite** | High vel_grad |
| 8652-12703 | Good | Solid but lower score |
| 9487-9102 | Good | Acceptable |
| 7443-12703 | Reject | Low rotation, `usable=False` |
| 12685-9101 | Reject | Low rotation, `vel_grad < 2.5` |
| 12071-12702 | Reject | Low `frac_valid_in_1.5Re` |
| 11013-6101 | Elite | Visually patchy but passed metrics |

### Final conclusion on scoring:
- Hard cuts (`frac_valid_in_1.5Re`, `vel_grad`, `mask_fraction`, `flux_max`) are scientifically solid
- Point system is arbitrary and should not be over-interpreted
- Clean subset of 6–8 galaxies truly excellent for toy experiments

---

## 3. Prep of Source Tensors (Reconfirmed Setup)

### `prep_source_maps.py` workflow:

Reads `data/usable_maps_index.txt` with 8 selected MAPS:
```
manga-8652-12703-MAPS.fits.gz
manga-12071-12702-MAPS.fits.gz
manga-8593-12705-MAPS.fits.gz
manga-9487-9102-MAPS.fits.gz
manga-11013-6101-MAPS.fits.gz
manga-8993-12705-MAPS.fits.gz
manga-11982-9102-MAPS.fits.gz
manga-10500-12703-MAPS.fits.gz
```

For each MAPS file:
1. Extract Hα flux and stellar velocity maps
2. Apply masks (invalid pixels → 0)
3. Normalize flux to [0, 1] using robust percentiles
4. Normalize velocity to ~[−1, 1] (median-centering + robust scale)
5. Resample to fixed 64×64 grid
6. Save as `data/source_tensors/source_tensor_{plateifu}.npy`
7. Generate preview PNG: flux + velocity side-by-side

### Preview review:
- All eight showed good flux morphologies and clean velocity gradients
- Some more compact, some more extended
- No obvious preprocessing bugs

---

## 4. Toy SIS Lens Demo: Verifying Geometric Lensing

### Used `sis_demo_lens.py` to:
- Load canonical tensor (e.g., `source_tensor_8993-12705.npy`)
- Apply pure SIS lens at origin with `theta_E = 0.5`
- Use same mapping for both channels (flux and velocity)
- Mask velocity wherever lensed flux < 0.1

### Output diagnostics:

**Flux channel:**
- Clean Einstein ring with central hole (as expected)
- Flux min 0, max ~1.0

**Velocity channel:**
- "Kinematic horseshoe" structure
- One side red (receding), opposite side blue (approaching)
- Gradient wraps nicely around ring
- Masking correctly zeroes out background

### Conclusion:
- Geometric mapping is physically consistent at toy level
- Lensing is coordinate remapping; same ray-tracing for flux and velocity
- Flux masking logic works correctly
- **Milestone 1 requirement satisfied:** end-to-end toy SIS lens on realistic MaNGA source

---

## 5. Toy CNN for Lensed vs Unlensed (Milestone 1 Classification)

### Dataset design:
- Uses same source tensors
- Half unlensed (original), half lensed (SIS-mapped)
- Simple augmentations (rotations, flips)

### CNN architecture:
```
Conv2d(2, 16, 3) → ReLU → MaxPool(2)
Conv2d(16, 32, 3) → ReLU → AdaptiveAvgPool(1)
Linear(32, 2)
```

### Train/val/test split:
- Train: 4 plateifus
- Val: 1 plateifu
- Test: 1 plateifu

### Results:
```
train_acc ≈ 1.0
val_acc ≈ 1.0
test_acc ≈ 1.0
```

### Interpretation:
- Lensed vs unlensed separation is **trivial** in this toy setup
- Ring morphology dramatically different from original disk
- Even pure flux is enough; velocity not needed
- **This is expected and acceptable for Milestone 1**

### Milestone 1 status:
| Component | Status |
|-----------|--------|
| Data loading / normalization / tensor creation | ✅ Done |
| Quality metrics and selection | ✅ Done |
| Toy SIS lens mapping | ✅ Done |
| Toy CNN (lensed vs unlensed) | ✅ Done and validated |

---

## 6. Subhalo CNN: First Attempt and Null Result

### Classification task:
- Class 0: smooth SIS macro lens
- Class 1: SIS macro + small SIS subhalo at on-arc positions

### Initial setup (before refactor):

| Parameter | Value |
|-----------|-------|
| `theta_E_sub_factor` | 0.1 × `theta_E_main` |
| `psf_sigma` | 1.0 pixel |
| `flux_noise_sigma` | 0.08 |
| `vel_noise_sigma` | 0.03 |
| Channels | Both flux + velocity |

### Training results (first run, with noise):
```
Train acc: ~0.55–0.58
Val acc:   ~0.48–0.55
Test acc:  ~0.70 (suspicious, probably easier test galaxy)
Loss:      ~0.67 (barely better than random 0.693)
```

### Interpretation:
- CNN could not reliably distinguish smooth vs (SIS + toy subhalo) in noisy setting
- **Hard null:** label information is weak in velocity channel; subhalo effect too subtle with PSF + noise

---

## 7. Debugging the Subhalo Signal (Visual Sanity Check)

### Created `debug_subhalo_samples.py`:

Produces a triplet for a given galaxy:
1. Smooth SIS (no subhalo), no PSF, no noise
2. SIS + subhalo, no PSF, no noise
3. SIS + subhalo + PSF + noise

### Observations:

| Case | Flux | Velocity |
|------|------|----------|
| Smooth | Clean ring | Clean horseshoe |
| Subhalo (clean) | Very subtle distortion near subhalo | Very subtle kink |
| Subhalo (with PSF+noise) | Distortion almost washed out | Kink essentially invisible |

### Conclusion:
- Subhalo-induced perturbation is physically present but:
  - Too small relative to PSF smoothing and noise
  - Especially weak in velocity channel after normalization

---

## 8. Centralizing Lensing Physics (`lensing_utils`)

### Created `src/glens/lensing_utils.py`:

**`LensSimConfig` dataclass:**
```python
theta_E_main: float = 0.5
theta_E_sub_factor: float = 0.1
psf_sigma: float = 1.0
flux_noise_sigma: float = 0.08
vel_noise_sigma: float = 0.03
flux_mask_threshold: float = 0.1
```

**Core functions:**
- `load_source_tensor()`
- `build_theta_grid()`
- `sis_deflection()` (macro + optional offset)
- `render_sis_lens()` (flux + velocity, with masking)
- `render_sis_plus_subhalo()` (macro + SIS subhalo on-arc)
- `apply_psf_and_noise()`

### Refactored scripts:
- `debug_subhalo_samples.py`
- `subhalo_cnn.py`
- `sis_demo_lens.py`

All now import from `lensing_utils` and use exactly the same physics and parameters.

### Benefit:
- Removed risk that training and debugging were using slightly different models
- Same SIS + subhalo deflection, PSF, noise behavior, flux-based velocity masking

---

## 9. Step-2 Experiments: Easier Subhalo and Controlled Channels

### 9.1 Easy Case: No PSF, No Noise, Strong Subhalo

| Parameter | Value |
|-----------|-------|
| `theta_E_main` | 0.5 |
| `theta_E_sub_factor` | **0.3** (3× stronger) |
| `psf_sigma` | 0.0 |
| `flux_noise_sigma` | 0.0 |
| `vel_noise_sigma` | 0.0 |

**Results:**

| Channel Mode | Train Acc | Val Acc | Test Acc |
|--------------|-----------|---------|----------|
| **Both** | 1.0 | 1.0 | 1.0 |
| **Flux only** | 1.0 | 1.0 | 1.0 |
| **Vel only** | 0.53–0.60 | 0.48–0.54 | 0.52–0.59 |

**Conclusion:**
- With strong subhalo and no noise: flux-only and flux+vel are trivial
- **Velocity-only remains near chance** — pure kinematic imprint is not a strong, isolated signal

### 9.2 Moderate Noise Case: PSF + Moderate Noise

| Parameter | Value |
|-----------|-------|
| `theta_E_sub_factor` | 0.3 |
| `psf_sigma` | 0.5 |
| `flux_noise_sigma` | 0.03 |
| `vel_noise_sigma` | 0.01 |

**Results:**

| Channel Mode | Train Acc | Val Acc | Test Acc |
|--------------|-----------|---------|----------|
| **Flux only** | ~1.0 | ~1.0 | ~1.0 |
| **Flux + velocity** | ~1.0 | ~1.0 | ~1.0 |
| **Vel only** | 0.53–0.57 | 0.48–0.54 | ~0.58 |

**Conclusion:**
- Flux dominates detection even with moderate noise
- Velocity-only still near-chance; slight fluctuation but no solid learning

---

## 10. Final Scientific Interpretation

### Milestone 1: ✅ Effectively Complete

| Achievement | Status |
|-------------|--------|
| Real MaNGA-based flux + velocity tensors | ✅ |
| Quantitative metrics and filtered high-quality galaxies | ✅ |
| Physically consistent SIS lens mapping for both channels | ✅ |
| Toy CNN perfectly distinguishes unlensed vs lensed | ✅ |

### Subhalo Experiment: Scientifically Honest Regime

**Key findings:**

1. **When subhalo is "big and clean" (no noise):**
   - Both flux-only and flux+vel CNNs succeed fully

2. **When adding moderate PSF + noise:**
   - Flux-only and flux+vel still succeed
   - Subhalo's morphological imprint is clearly detectable in flux

3. **Velocity-only:**
   - **Fails to rise significantly above chance in all tested regimes**
   - Low performance is NOT a data-volume issue (training accuracy stays low)
   - Information tying label ↔ velocity map is intrinsically weak in this setup

### What this experiment answers:
- ✅ "Can we detect a fairly large on-arc subhalo from flux morphology?" → **Yes, trivially**
- ❓ "Does adding kinematics provide extra discriminative power?" → **Not yet in this toy configuration**
- ❌ "Can velocity-only detect subhalos?" → **No, near-chance performance**

---

## 11. Options for Next Steps

### Option A: Tighten the "Kinematic Advantage" Experiment
**Goal:** Design experiment where flux-only becomes ambiguous, but velocity provides extra information.

Possible actions:
- Construct scenarios where flux morphology of smooth vs subhalo is very similar
- Use same flux map for both classes, but different velocity fields
- Isolates: "Can CNN use velocity to detect anomaly when flux is deliberately uninformative?"

### Option B: Improve Subhalo + Kinematic Physics
**Goal:** Make velocity perturbation physically stronger and better modeled.

Changes:
- Replace SIS subhalo with truncated NFW using lenstronomy
- Model local velocity dispersion enhancement or non-circular motions near subhalo
- Explore higher-resolution grids (128×128)
- Use smaller PSF or oversampled ray tracing
- Start with very low kinematic noise, then ramp up

### Option C: Document and Consolidate Results
**Goal:** Turn today's work into clean documentation for reports.

Tasks:
- Write concise "Methods + Results" section
- Tabulate per-galaxy metrics and per-experiment accuracies
- Lock in achievements for judges/collaborators

### Option D: Code Hygiene & Small Utilities
**Goal:** Make codebase easier to extend.

Tasks:
- Add config YAML/JSON for experiment parameters
- CLI to sweep over noise/subhalo factors and log to CSV
- Add thorough docstrings and comments

### Recommended path forward:
1. **First:** Option C (document & freeze Milestone 1 + Step-2 results)
2. **Then:** Pick either Option A (controlled "kinematics-only" toy) or Option B (upgrade physics with lenstronomy)
3. **Avoid:** Doing both in parallel until one story is cleanly established

---

## Files Created/Modified Today

| File | Action |
|------|--------|
| `src/glens/__init__.py` | Created |
| `src/glens/lensing_utils.py` | Created |
| `src/scripts/debug_subhalo_samples.py` | Refactored to use `lensing_utils` |
| `src/scripts/subhalo_cnn.py` | Refactored with Step-2 CLI args and channel modes |
| `src/scripts/sis_demo_lens.py` | Refactored to use `lensing_utils` |
| `src/utils/lensibility.py` | Created (lensibility scoring) |
| `src/scripts/score_lensability.py` | Created |
| `data/source_tensors/compactness_metrics.csv` | Updated |
| `data/maps_lensability_scored.csv` | Created |

---

## Key Takeaway

> **Morphology (flux) is currently carrying the load for subhalo detection. The CNN does not need kinematics to detect this toy subhalo. The experiment is now in a scientifically honest regime, and the next step should deliberately explore conditions where velocity might actually matter.**

