# Work Log - November 30, 2024

## Summary

Built a complete MaNGA → ML-ready tensor pipeline from scratch. Started with no concrete implementation and ended with 8 validated galaxy tensors ready for lensing simulation.

---

## 1. Starting Point

At the beginning of this session, I had:

- ❌ No concrete Python project structure for this ISEF idea
- ❌ No MaNGA files downloaded
- ❌ No working code to:
  - Locate MaNGA DR17 DAP/DRP files
  - Rank galaxies for kinematic quality
  - Extract and normalize flux + velocity maps into ML-ready tensors
- ✅ Only a conceptual project idea (multi-modal subhalo detection using flux + kinematics)

**In other words: Started from scratch on the implementation side for the MaNGA → tensor processing pipeline.**

---

## 2. What I Accomplished Today

### 2.1 Project Setup and Data Source Discovery

- **Clarified Milestone 1**: Extract flux + velocity maps from real MaNGA IFU data, normalize and resample them into a consistent 2-channel tensor format for use in lensing simulation and CNN models.

- **Established Python project scaffolding**:
  - `requirements.txt` with numpy, scipy, astropy, matplotlib, torch, torchvision
  - `src/` for scripts
  - `data/` for storage

- **Located key MaNGA DR17 analysis products**:
  - `dapall-v3_1_1-3.1.0.fits`
  - `drpall-v3_1_1.fits`
  - Directory layout for accessing MAPS FITS files using plate and IFU IDs

- **Understood the difference** between MAPS (2D derived data) vs LOGCUBE (3D spectra), and confirmed that only MAPS is needed for Milestone 1.

---

### 2.2 Single-Galaxy Inspection and Understanding of MAPS Content

- Wrote and ran `load_manga_maps.py` to open a MAPS file (`manga-8138-12704`)
- Listed HDUs and inspected shapes
- **Identified key extensions**:
  | Extension | Shape | Description |
  |-----------|-------|-------------|
  | `EMLINE_GFLUX` | (35×72×72) | Emission line flux maps |
  | `EMLINE_GVEL` | (35×72×72) | Gas velocity maps |
  | `STELLAR_VEL` | (72×72) | Stellar velocity map |

- Extracted and plotted Hα flux and velocity maps
- Wrote `inspect_manga_data.py` to verify:
  - **Hα index is 24** (confirmed from header)
  - **Units are correct**:
    - Flux: `1e-17 erg/s/cm²/spaxel`
    - Velocity: `km/s`
- Confirmed strong, clean rotation with high flux/velocity correlation (~0.98)

---

### 2.3 Ranking MaNGA Galaxies for Kinematic Quality

- Wrote `rank_manga_disks.py` using dapall/drpall catalogs
- **Used columns**:
  - `HA_GSIGMA_1RE`
  - `STELLAR_SIGMA_1RE`
  - `EMLINE_GFLUX_1RE[24]` (Hα flux)
- Computed a custom ranking score using flux, dispersion, and inclination
- Generated `data/manga_disk_candidates.csv` with ranked galaxies
- Built derived URLs pointing to remote MAPS FITS files
- Confirmed the example galaxy ranked **229th out of 7,363**

---

### 2.4 Downloading Top Candidates

- Implemented `download_manga_maps_from_csv.py`
- Downloaded the **top 10 MAPS files** from ranked list
- All files saved under `data/maps/` without errors

---

### 2.5 Batch Inspection and Threshold Refinement

- Wrote `batch_inspect_maps.py` to analyze:
  - Velocity gradient
  - Flux–velocity correlation
  - Mask fraction
  - Valid spaxel fraction within 1.5 × Rₑ

- **Initial thresholds were too conservative** → 0/10 usable

- **Refined thresholds**:
  - Focused analysis on galaxy core regions
  - Raised mask threshold from 40% → 70%

- **Re-ran and got 8 out of 10 marked as usable**

- This restored confidence in MaNGA as a valid source for kinematic templates

---

### 2.6 Building ML-Ready 2-Channel Tensors

- Created `usable_maps_index.txt` containing IDs of the 8 selected galaxies
- Implemented `prep_source_maps.py` with:
  - Flux and velocity extraction
  - Masking, normalization, and percentile scaling
  - Resampling to 64×64
  - Saving as `.npy` tensors with shape `(2, 64, 64)`
  - Generating preview PNGs
- **Successfully generated all 8 tensors and previews**
- ✅ Established a complete functional **raw MAPS → ML-ready tensor pipeline**

---

### 2.7 Visual Interpretation

Manually reviewed all 8 preview maps:

| Finding | Implication |
|---------|-------------|
| Velocity maps showed strong dipole structures | Excellent rotation fields |
| Flux maps revealed 3 galaxies with extended/clumpy emission | Suitable as lensing sources |
| Compact, overly centered flux galaxies | Not ideal for arcs, but useful for degeneracy testing |

**Identified the ambiguity of velocity=0** (masked vs systemic) and planned to fix it by **flux-weighted masking after lensing**.

---

### 2.8 Big-Picture Positioning

- **Redefined MaNGA's role**:
  - NOT a labeled dataset
  - Instead: calibration of realistic source-plane templates and kinematic behavior

- **Finalized complete long-term roadmap** (Phases 0–7), including:
  - Analytic models
  - Lensing simulation (lenstronomy)
  - Pipeline for dual-channel dataset
  - CNN baseline implementation
  - Perturbation testing with subhalos

---

## 3. Core Findings

| Finding | Detail |
|---------|--------|
| MaNGA DR17 provides high-quality rotating disks | Confirmed via gradient analysis |
| Velocity maps excellent for kinematics modeling | Strong dipole patterns visible |
| Flux distributions vary | Selection must consider spatial structure |
| Masking ambiguity is real but solvable | Use flux-thresholded masking |
| Real data alone insufficient | Simulated lensing necessary for labeled training |

---

## 4. Risks Explicitly Derisked Today

| Risk Category | How I Mitigated |
|---------------|-----------------|
| Data Quality | Ranking, metrics, valid fractions, manual inspection |
| Masking Ambiguity | Plan for flux-weighted masking in simulator |
| Over-reliance on Real Data | Use MaNGA only for calibration/templates; simulations for training |
| Complexity of Kinematic Modeling | Start with simple analytic disks, validate using MaNGA |

---

## 5. Milestone 1 Status

### Definition

Build a full, functioning preprocessing pipeline that:
- ✅ Locates and downloads MaNGA MAPS files
- ✅ Ranks galaxies for kinematic strength
- ✅ Extracts Hα flux and velocity maps
- ✅ Normalizes and resamples to 64×64
- ✅ Saves ML-ready 2-channel tensors + preview images

### Status

| Task | Status |
|------|--------|
| Discover directory structure | ✅ Complete |
| Ranking via dapall/drpall | ✅ Complete |
| Download MAPS files | ✅ Complete |
| Batch inspect & threshold refinement | ✅ Complete |
| Create usable_maps_index.txt | ✅ Complete |
| Convert to tensors | ✅ Complete |
| Generate preview images | ✅ Complete |
| Write Tensor Data Contract | ⬜ Pending |

**Only the Tensor Data Contract documentation remains.**

---

## 6. Next Steps

### Immediate

1. **Write Tensor Data Contract / README**
   - Define tensor shapes `(2, 64, 64)`
   - Normalization details
   - Mapping back to physical units
   - File naming conventions

2. **Choose canonical galaxies for simulations**
   - Primary: `8652-12703` or `8593-12705`
   - Secondary: `8993-12705`, `12071-12702`, `10500-12703`

### Move to Milestone 2

- Implement simple SIS lensing
- Apply flux-weighted masking of velocity
- Compare unlensed vs lensed tensors visually

---

## Files Created/Modified Today

| File | Description |
|------|-------------|
| `src/scripts/load_manga_maps.py` | Quick demo/visualization |
| `src/scripts/inspect_manga_data.py` | Deep diagnostic analysis (6 sections) |
| `src/scripts/rank_manga_disks.py` | Catalog-level galaxy ranking |
| `src/scripts/download_manga_maps_from_csv.py` | Download MAPS files from CSV |
| `src/scripts/batch_inspect_maps.py` | Batch quality inspection |
| `src/scripts/prep_source_maps.py` | Tensor preparation pipeline |
| `src/constants.py` | Physical constants (pixel scale, Hα index) |
| `src/data_io/fits_loader.py` | Generic FITS loader class |
| `src/data_io/manga_extractor.py` | MaNGA-specific extraction |
| `src/processing/prep_source_maps.py` | Processing module |
| `docs/PROJECT_PLAN.md` | Complete 7-phase project plan |
| `data/usable_maps_index.txt` | List of 8 usable galaxies |
| `data/maps_quality_summary.csv` | Quality metrics for all galaxies |
| `.gitignore` | Excludes myenv, source_tensors, FITS files |

---

## Output Artifacts

```
data/source_tensors/
├── source_tensor_8593-12705.npy    # (2, 64, 64) - Hero galaxy
├── source_tensor_8652-12703.npy
├── source_tensor_8993-12705.npy
├── source_tensor_10500-12703.npy
├── source_tensor_11013-6101.npy
├── source_tensor_11982-9102.npy
├── source_tensor_12071-12702.npy
├── source_tensor_9487-9102.npy
└── previews/
    ├── preview_8593-12705.png
    └── ... (8 preview images)
```

---

*Session duration: ~6 hours*

