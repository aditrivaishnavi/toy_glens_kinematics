# Paper IV Parity: EfficientNetV2-S — CORRECTED ANNULUS
# ====================================================
# This config retrains with the corrected normalization annulus.
#
# Change from v1: annulus_r_in=32.5, annulus_r_out=45.0
#   (computed by default_annulus_radii(101, 101))
# The old annulus (20, 32) sat within the galaxy light for 101x101
# stamps, inflating MAD and suppressing arc contrast. See KNOWN ISSUE
# in dhs/utils.py for full context.
#
# IMPORTANT: The checkpoint from this run MUST NOT be mixed with
# checkpoints from v1-v4 (which used the old annulus). All scoring
# and selection-function runs must also use the new annulus.
#
# Protocol: 160 epochs, StepLR halve@130, effective batch 512,
#           unweighted CE, 101x101, CORRECTED ANNULUS
# Date: 2026-02-13

dataset:
  parquet_path: ""
  manifest_path: /lambda/nfs/darkhaloscope-training-dc/stronglens_calibration/manifests/training_parity_70_30_v1.parquet
  mode: file_manifest
  preprocessing: raw_robust
  label_col: label
  cutout_path_col: cutout_path
  sample_weight_col: sample_weight
  seed: 42
  crop: false           # Keep 101x101 for Paper IV parity
  crop_size: 0
  # CORRECTED annulus: from default_annulus_radii(101, 101)
  # Old values were (20, 32) — problematic for 101x101 stamps
  annulus_r_in: 32.5
  annulus_r_out: 45.0

augment:
  hflip: true
  vflip: true
  rot90: true

train:
  arch: efficientnet_v2_s
  epochs: 160
  batch_size: 64
  effective_batch: 512
  lr: 0.000388
  weight_decay: 0.0001
  lr_schedule: step
  lr_step_epoch: 130
  lr_gamma: 0.5
  num_workers: 8
  device: cuda
  early_stopping_patience: 0
  out_dir: /lambda/nfs/darkhaloscope-training-dc/stronglens_calibration/checkpoints/gen5a_efficientnet_annulus_fix
  mixed_precision: true
  unweighted_loss: true
  pretrained: true
  # Q1.22 fix: match v2 training recipe (freeze backbone for early epochs,
  # linear LR warmup) — critical for pretrained EfficientNetV2-S
  freeze_backbone_epochs: 5
  warmup_epochs: 5
