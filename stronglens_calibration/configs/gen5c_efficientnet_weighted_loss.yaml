# Paper IV Parity: EfficientNetV2-S â€” CORRECTED ANNULUS + WEIGHTED LOSS
# =====================================================================
# This config retrains with the corrected normalization annulus AND
# weighted loss (using sample_weight column: Tier-A=1.0, Tier-B=0.5).
#
# EXPERIMENT MOTIVATION (LLM reviewer recommendation, Q6.7/Q6.8):
# All previous configs use unweighted_loss: true with 93:1 neg:pos ratio.
# This means positives contribute ~1% of the loss. Weighted loss should:
#   - Down-weight noisy Tier-B labels (sample_weight=0.5)
#   - Potentially improve recall and calibration at low FPR
#
# This is an ablation experiment: compare v5 (unweighted) vs v5-wl (weighted)
# to isolate the effect of sample weighting on model performance.
#
# Protocol: 160 epochs, StepLR halve@130, effective batch 512,
#           WEIGHTED CE, 101x101, CORRECTED ANNULUS
# Date: 2026-02-13

dataset:
  parquet_path: ""
  manifest_path: /lambda/nfs/darkhaloscope-training-dc/stronglens_calibration/manifests/training_parity_70_30_v1.parquet
  mode: file_manifest
  preprocessing: raw_robust
  label_col: label
  cutout_path_col: cutout_path
  sample_weight_col: sample_weight
  seed: 42
  crop: false
  crop_size: 0
  annulus_r_in: 32.5
  annulus_r_out: 45.0

augment:
  hflip: true
  vflip: true
  rot90: true

train:
  arch: efficientnet_v2_s
  epochs: 160
  batch_size: 64
  effective_batch: 512
  lr: 0.000388
  weight_decay: 0.0001
  lr_schedule: step
  lr_step_epoch: 130
  lr_gamma: 0.5
  num_workers: 8
  device: cuda
  early_stopping_patience: 0
  out_dir: /lambda/nfs/darkhaloscope-training-dc/stronglens_calibration/checkpoints/gen5c_efficientnet_weighted_loss
  mixed_precision: true
  # KEY CHANGE: Enable weighted loss using manifest sample_weight column
  unweighted_loss: false
  pretrained: true
  freeze_backbone_epochs: 5
  warmup_epochs: 5
