```markdown
# Phase 2: LRG Hyperparameter Grid and Halo–Environment Mapping

In Phase 2 I moved from “one conservative LRG definition” (Phase 1.5) to a **hyperparameter grid** of LRG selections, applied uniformly across the **DR10 South sweep footprint**. The goals were:

- Understand how different color–magnitude cuts change:
  - the number of LRGs selected,
  - their spatial clustering, and
  - the resulting candidate “massive halo” environments.
- Choose a **single, physics-motivated baseline** that is rich enough for statistics but still biased toward massive halos that are good strong-lensing hosts.

This report documents what I actually ran, what the data show numerically, and why I am adopting **Variant 3 (“color-relaxed” LRGs)** as the baseline for all downstream phases.

---

## 1. Data and Scope

### Input imaging

- Legacy Survey DR10, **southern “DECaLS” sweeps**
  - File list: `sweep_urls_full.txt` pointing to  
    `https://portal.nersc.gov/cfs/cosmo/data/legacysurvey/dr10/south/sweep/10.1/…`
  - These sweeps cover the **southern and equatorial sky** (roughly declinations up to ≈ +30 degrees).
  - The **northern imaging (MzLS/BASS)** is intentionally not included in Phase 2, so all results are limited to DR10 South.

### Sky tessellation

- The sky is divided into **bricks** (standard Legacy Survey bricks, roughly 0.25° × 0.25°).
- Total bricks in `phase2_results.csv`:
  - `N_bricks = 322,385`

### Per-brick quantities in `phase2_results.csv`

- `brickname`
- `n_gal` (total number of galaxies in that brick passing basic DR10-quality cuts)
- `n_lrg_v1_pure_massive`
- `n_lrg_v2_baseline_dr10`
- `n_lrg_v3_color_relaxed`
- `n_lrg_v4_mag_relaxed`
- `n_lrg_v5_very_relaxed`

For intuition I treat each brick as having area ≈ 0.0625 deg² (0.25° × 0.25°) when converting to surface densities. The exact brick areas are computed later in the TAP-based region analysis.

---

## 2. LRG Selection Model and Hyperparameter Grid

### 2.1 Basic LRG selection structure

All variants share the same basic structure:

1. Use **extinction-corrected nanomaggies** in `r`, `z`, and `W1`, converted to magnitudes:
   - \( m = 22.5 - 2.5 \log_{10}(\text{flux\_corr}) \)
2. Apply a morphology cut to exclude stellar PSF sources:
   - e.g. `TYPE != 'PSF'` in the Tractor catalogs.
3. Apply variant-specific **magnitude and color cuts** in the space:
   - \( z_{\text{mag}} \)
   - \( (r - z) \)
   - \( (z - W1) \)

The idea is standard: **Luminous Red Galaxies (LRGs)** trace the most massive dark matter halos. Stricter cuts select the reddest, most massive systems (high purity, low completeness). Relaxed cuts include lower mass or less red galaxies (higher completeness, more contamination).

### 2.2 Hyperparameter grid: five LRG variants

I defined five LRG selection variants, from very strict to very relaxed:

| Variant name | z-band limit | Color cuts | Intuition |
|---|---:|---|---|
| **v1_pure_massive** | \( z < 20.0 \) | \( (r - z) \ge 0.8,\ (z - W1) \ge 1.8 \) | Extremely bright and very red; designed to pick only the most massive, old stellar populations in massive halos. |
| **v2_baseline_dr10** | \( z < 20.4 \) | \( (r - z) \ge 0.4,\ (z - W1) \ge 1.6 \) | Matches the conservative Phase 1.5 “baseline” LRG cut tuned on DR10. Bright and red, somewhat closer to DESI-like LRGs. |
| **v3_color_relaxed** | \( z < 20.4 \) | \( (r - z) \ge 0.3,\ (z - W1) \ge 0.8 \) | Keeps the same brightness ceiling, but relaxes color cuts to admit somewhat bluer / less extreme galaxies while still preferring red sequence systems. |
| **v4_mag_relaxed** | \( z < 20.8 \) | \( (r - z) \ge 0.3,\ (z - W1) \ge 0.8 \) | Same color as v3, but allows fainter galaxies, increasing completeness at fixed color. |
| **v5_very_relaxed** | \( z < 21.2 \) | No explicit color cuts | Very inclusive luminous galaxy selection; essentially “bright galaxies” with minimal color filtering. Maximizes completeness but allows substantial contamination by lower mass / star-forming systems. |

So Phase 2 is effectively a **purity–completeness scan** in the space of:

- brightness (z magnitude limit),
- red color (r − z),
- red plus infrared color (z − W1).

---

## 3. Global Statistics From Phase 2

All statistics below are computed directly from `phase2_results.csv`.

- `N_bricks = 322,385`

### 3.1 All galaxies (`n_gal`)

`n_gal` statistics:

- min: 8  
- median: 2,909  
- mean: 3,191.4  
- max: 59,346  

If I approximate each brick as 0.0625 deg², this corresponds to:

- median **galaxy surface density** ≈ 2,909 / 0.0625 ≈ 46,544 galaxies per deg²
- mean ≈ 51,062 galaxies per deg²

These are sensible numbers for DR10 depth.

### 3.2 LRG counts per variant

For each variant I summarize:

- median and mean LRGs per brick,
- approximate median and mean surface densities,
- fraction of all bricks with at least one LRG,
- median fraction of galaxies in a brick that are tagged as LRGs.

I use area 0.0625 deg² as a simple, consistent reference for densities.

| Variant | Median LRG/brick | Mean LRG/brick | Median density (deg⁻²) | Mean density (deg⁻²) | Bricks with ≥1 LRG (%) | Median LRG fraction of galaxies (%) |
|---|---:|---:|---:|---:|---:|---:|
| v1_pure_massive | 1.0 | 1.8 | 16 | 29 | 77.5 | 0.057 |
| v2_baseline_dr10 | 5.0 | 6.1 | 80 | 97 | 93.2 | 0.203 |
| v3_color_relaxed | 75.0 | 76.0 | 1,200 | 1,216 | 99.9+ | 1.69 |
| v4_mag_relaxed | 174.0 | 176.1 | 2,784 | 2,818 | 100.0 | 4.11 |
| v5_very_relaxed | 310.0 | 310.3 | 4,960 | 4,965 | 100.0 | 7.28 |

Notes:

- These numbers are **per brick** across the entire DR10 South sweep set.
- The **LRG fraction** is computed as the median of `(n_lrg_variant / n_gal)` across bricks.

This table makes the purity–completeness ladder explicit:

- v1 selects about **0.06%** of galaxies.
- v3 selects about **1.7%** of galaxies.
- v5 selects about **7.3%** of galaxies.

So Phase 2 provides a quantitative mapping between my cuts and the fraction of the galaxy population I treat as “visible dark matter halos.”

### 3.3 High-density “candidate” bricks per variant

For each variant I examined how often bricks sit in the very high-density tail. I computed:

- percentile thresholds of LRG counts per brick: p90, p95, p99,
- and counted how many bricks lie at or above the 99th percentile.

Percentiles:

| Variant | p90 LRG/brick | p95 LRG/brick | p99 LRG/brick |
|---|---:|---:|---:|
| v1_pure_massive | 5 | 7 | 13 |
| v2_baseline_dr10 | 11 | 14 | 22 |
| v3_color_relaxed | 118 | 146 | 207 |
| v4_mag_relaxed | 259 | 309 | 419 |
| v5_very_relaxed | 427 | 495 | 664 |

Number of bricks at or above the 99th percentile:

- v1: 3,243 bricks  
- v2: 3,232 bricks  
- v3: 3,230 bricks  
- v4: 3,237 bricks  
- v5: 3,228 bricks  

This is consistent with ≈322k bricks: about 1% of them end up in the top 1% for each variant. The key scientific point is that those “top 1%” bricks correspond to **different physical environments** depending on the variant:

- in v1 they are extreme overdensities of very red, very bright galaxies,
- in v5 they are overdensities of a much more inclusive galaxy population.

---

## 4. Physics Interpretation of Each Variant

Here I interpret each selection in terms of halo mass and eventual strong lensing science.

### 4.1 v1_pure_massive

- Cuts: bright and extremely red (`z < 20.0`, `r − z ≥ 0.8`, `z − W1 ≥ 1.8`)
- Fraction of galaxies selected: ≈ 0.06%
- Median density ≈ 16 LRG/deg²

Physics intuition:

- Effectively a **“cluster BCG plus richest neighbors”** selection.
- So strict that in many bricks the count is zero or one; only densest cluster cores rise to double digits.

Pros:

- Very pure in terms of halo mass: almost everything selected lives in the most massive environments.

Cons:

- **Counts are too low** for robust statistics.
- Poisson noise is large: N ~ 1 to 10 per brick means fractional uncertainties of 30% to 100%.
- As a practical parent sample for thousands of mock lenses, this is **too sparse**.

I view v1 as a sanity check, not a viable production baseline.

### 4.2 v2_baseline_dr10

- Cuts: `z < 20.4`, `r − z ≥ 0.4`, `z − W1 ≥ 1.6`
- Matches the conservative Phase 1.5 baseline and is somewhat DESI-like
- Fraction of galaxies selected: ≈ 0.2%
- Median density ≈ 80 LRG/deg²

Physics intuition:

- Still focused on very red, massive galaxies, but less extreme than v1.

Pros:

- Denser than v1 by a factor of ~5 in surface density.
- Nearly all bricks (93%) contain at least one LRG, which helps mapping.

Cons:

- Counts are still low (median ~5 per brick).
- Differences like “5 vs 8 vs 10” are marginal once Poisson noise is considered.
- Overdensity maps remain somewhat noisy.

I consider v2 a good reference, but not the statistical sweet spot.

### 4.3 v3_color_relaxed (chosen baseline)

- Cuts: `z < 20.4`, `r − z ≥ 0.3`, `z − W1 ≥ 0.8`
- Same brightness as v2, but color thresholds relaxed
- Fraction of galaxies selected: ≈ 1.7%
- Median density ≈ 1,200 LRG/deg²

Physics intuition:

- Still prefers red galaxies, but admits a broader slice of the massive and moderately massive population:
  - red sequence ellipticals,
  - slightly bluer but still relatively massive systems.

Pros:

- Counts are now statistically useful:
  - median 75 per brick,
  - p90 118, p95 146, p99 207.
- Differences like “75 vs 150 vs 250 per brick” are much larger than Poisson fluctuations.
- Still biased toward plausible lens hosts and members of massive halos without being ultra-extreme.

Cons:

- Less pure than v1/v2 in strict halo-mass terms; more intermediate-mass hosts.

In practice, v3 is the Goldilocks point: enough signal for robust maps and ML training, while still emphasizing environments where strong lensing is likely. This is why I choose **v3_color_relaxed** as the default baseline.

### 4.4 v4_mag_relaxed

- Cuts: `z < 20.8`, `r − z ≥ 0.3`, `z − W1 ≥ 0.8`
- Same color as v3, but extends 0.4 mag fainter
- Fraction of galaxies selected: ≈ 4.1%
- Median density ≈ 2,784 LRG/deg²

Physics intuition:

- Adds fainter galaxies at similar colors, corresponding to lower stellar mass halos and more satellites.

Pros:

- Stronger counts per brick, useful to trace large-scale structure.

Cons:

- Drifts from a clean massive-halo tracer:
  - more satellites,
  - more moderate-mass halos,
  - more contamination by non-ideal lens hosts.
- If used as the only definition, risks diluting correlation between environment richness and lensing probability.

I treat v4 as a comparison sample rather than the primary definition.

### 4.5 v5_very_relaxed

- Cuts: `z < 21.2`, no explicit color cuts
- Fraction of galaxies selected: ≈ 7.3%
- Median density ≈ 4,960 LRG/deg²

Physics intuition:

- Essentially a **bright-galaxy selection** with minimal color filtering.
- Captures a broad halo population including many lower-mass and star-forming systems.

Pros:

- Extremely dense; useful if I want nearly all bright galaxies as environment tracers.

Cons:

- Too inclusive for strong lensing and massive-halo interpretation:
  - weaker connection to “massive halo,”
  - reduced purity as a tracer of high-mass structures,
  - overdensities are harder to interpret in halo-mass terms.

I view v5 as a control sample, not a baseline.

---

## 5. Region-level Structure in Phase 2

Phase 2 also attempted a region-level grouping:

- For each variant, I thresholded bricks by high LRG counts (e.g. p90, p95, p99) and built **contiguous regions** using neighboring bricks.
- For each region I computed:
  - number of bricks,
  - total area (deg²),
  - mean and median LRG densities per variant,
  - median seeing, depth, and extinction.

Region summary files (one per variant):

- `phase2_analysis/v*/phase2_regions_summary.csv`
- `phase2_analysis/v*/phase2_regions_bricks.csv`

For this full-sky DR10 South run with no RA/Dec restriction, I imposed an area window:

- `min_region_area_deg2 = 2.0`
- `max_region_area_deg2 = 400.0`

However, with the thresholds and connectivity used in this pass, **all regions ended up smaller than 2 deg²**, so:

- `keep_in_area_window` is **False for every region** in this specific Phase 2 run.

In this configuration Phase 2 mainly gives:

- global statistics per variant, and
- a catalog of compact overdensities,

but not yet a small set of large contiguous survey fields. For field selection I rely on Phase 1.6 and a future re-run of the region grouping tuned to produce regions of tens to hundreds of square degrees.

---

## 6. Why I Choose Variant 3 Going Forward

Putting everything together:

1. **Statistical power**
   - v1 and v2 have median counts too low per brick for robust ranking; Poisson noise dominates.
   - v3 has median 75 per brick and a strong high-density tail; overdensities become statistically meaningful.
   - v4 and v5 give higher counts but dilute the link to massive early-type halos.

2. **Physical relevance for strong lensing**
   - Strong lenses at relevant angular scales are hosted preferentially in **massive, red galaxies and their groups/clusters**.
   - v3 preserves that focus by requiring red colors in both `r − z` and `z − W1`, while capturing a realistic range of massive halos.

3. **Bias–completeness tradeoff**
   - v1 is too biased toward only the most extreme halos and becomes too sparse.
   - v5 trades away too much purity and becomes a general bright-galaxy catalog.
   - v3 sits where:
     - the data volume is large enough for ML training and completeness curves, and
     - the interpretation in terms of halos and lensing cross section remains relatively clean.

4. **Practical considerations**
   - v3 densities are high enough that any primary field selected using these counts will provide:
     - thousands to tens of thousands of potential hosts in a moderate area, and
     - enough galaxies to support injected lens simulations and robust completeness curves.
   - v3 aligns with Phase 1.5’s more conservative baseline, enabling smooth comparisons across phases.

Because of these points, I adopt **v3_color_relaxed** as the default “visible halo” definition for:

- selecting parent galaxies for simulation injection,
- building halo-environment dependent completeness functions, and
- defining main lens search fields in later phases.

I will keep v1, v2, v4, and v5 as comparison tracks to quantify how inferred “visibility” depends on the selection function, but the main narrative will be anchored in v3.

---

## 7. Implications for the Overall Project

Phase 2 achieves:

- A quantitative mapping of how my LRG selection function influences:
  - fraction of galaxies treated as halo tracers,
  - surface densities of potential lens hosts, and
  - frequency of extreme overdensities.
- A clear demonstration that:
  - an ultra-pure massive selection (v1) is not usable alone for statistical mapping,
  - a very relaxed bright-galaxy selection (v5) loses too much connection to massive halos,
  - a mid-range color-relaxed selection (v3) is a robust compromise.

For an ISEF-level narrative, Phase 2 appears as:

- a selection-function hypergrid figure and table,
- density histograms and sky maps per variant,
- a summary linking cut choices to which dark matter halos are “visible” in the survey.

Downstream phases will:

1. Use v3 to define the parent galaxy sample in chosen fields.
2. Inject synthetic strong lenses into these real backgrounds.
3. Train and test ML detectors.
4. Measure completeness as a function of lens parameters and host environment.
5. Interpret results in terms of which dark matter halos DR10 makes visible and how that biases dark matter inferences.

Phase 2 is therefore the backbone of the selection function for the entire project.
```

